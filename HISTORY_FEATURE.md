# 对话历史记录功能说明

## 功能概述

本项目已实现对话历史记录功能，可以按照时间和对话轮数将每条对话记录保存在 SQLite 数据库文件中。

## 数据库结构

### 1. conversation_history 表
存储每轮对话的详细记录：
- `id`: 自增主键
- `session_id`: 会话ID
- `turn_number`: 对话轮数（从1开始递增）
- `role`: 角色（user/assistant）
- `content`: 对话内容
- `timestamp`: Unix时间戳
- `created_at`: 可读的时间字符串（格式：YYYY-MM-DD HH:MM:SS）

### 2. sessions 表
存储会话基本信息：
- `session_id`: 会话ID（主键）
- `start_time`: 会话开始时间（Unix时间戳）
- `start_time_str`: 可读的开始时间
- `last_update`: 最后更新时间
- `total_turns`: 总对话轮数

## 使用方法

### 1. 进行对话并自动保存
```bash
python main.py
```

对话过程中，每轮对话都会自动保存到数据库中，包括：
- 用户输入
- 助手回复
- 对话轮数
- 时间戳

每次运行会创建一个新的会话（session），会话ID格式为 `session_<timestamp>`

### 2. 查看所有历史会话
```bash
python view_history.py
```

这会显示所有历史会话的列表，包括：
- 会话ID
- 开始时间
- 对话轮数

### 3. 查看指定会话的详细记录
```bash
python view_history.py <session_id>
```

例如：
```bash
python view_history.py session_1699123456789
```

这会显示该会话的完整对话记录，按轮次组织。

## 配置

在 `config.yaml` 中可以配置数据库路径：

```yaml
storage:
  sqlite_path: ./cache/meta.sqlite
  history_db_path: ./cache/conversation_history.db  # 对话历史数据库路径
```

默认情况下，数据库文件会保存在 `./cache/conversation_history.db`

## 示例输出

### 对话时的保存提示
```
用户: 你好
----------<构建的Prompt>----------
...
----------<构建的Prompt>----------
助手: 你好！有什么我可以帮助你的吗？
[第1轮对话已保存]
----------<本轮对话结束>----------
```

### 查看历史会话列表
```
=== 所有会话列表 ===

会话ID: session_1699123456789
开始时间: 2025-11-05 14:30:56
对话轮数: 5
--------------------------------------------------
会话ID: session_1699120000000
开始时间: 2025-11-05 13:33:20
对话轮数: 3
--------------------------------------------------
```

### 查看具体会话详情
```
=== 会话详情: session_1699123456789 ===

第 1 轮对话 [2025-11-05 14:30:56]:
用户: 你好
助手: 你好！有什么我可以帮助你的吗？
--------------------------------------------------

第 2 轮对话 [2025-11-05 14:31:23]:
用户: 今天天气怎么样？
助手: 抱歉，我无法实时获取天气信息。建议您查看天气应用或网站。
--------------------------------------------------
```

## 代码结构

- `src/history_store.py`: 历史记录管理类
  - `HistoryStore`: 主类，负责数据库操作
  - `start_session()`: 开始新会话
  - `save_turn()`: 保存一轮对话
  - `get_session_history()`: 获取会话历史
  - `get_all_sessions()`: 获取所有会话列表
  - `get_recent_history()`: 获取最近N轮对话（用于构建上下文）

- `main.py`: 主程序，集成了历史记录保存功能

- `view_history.py`: 查看历史记录的工具脚本

## 特性

1. **自动保存**: 每轮对话自动保存，无需手动操作
2. **时间记录**: 记录精确的时间戳和可读的时间字符串
3. **会话管理**: 每次启动程序创建新会话，方便区分不同的对话
4. **轮数追踪**: 准确记录对话轮数，方便分析对话流程
5. **数据完整**: 同时保存用户输入和助手回复
6. **易于查询**: 提供便捷的查询工具，支持查看所有会话和特定会话详情
7. **索引优化**: 创建数据库索引，提高查询效率
